<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:aop="http://www.springframework.org/schema/aop"
	xmlns:lang="http://www.springframework.org/schema/lang" xmlns:util="http://www.springframework.org/schema/util"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.2.xsd
		http://www.springframework.org/schema/lang http://www.springframework.org/schema/lang/spring-lang-4.2.xsd
		http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-4.2.xsd">
	
	<!--==================================================================================-->
	<!-- FoD CONNECTION CONFIGURATION -->
	<!--==================================================================================-->
	
	<!-- This bean defines a proxy configuration used to access FoD. By default
	     no proxy is used. If necessary, proxy settings can either be entered here,
	     or using -FoDProxyUrl, -FoDProxyUserName and -FoDProxyPassword command line
	     options. If a proxy user name is specified without a password, the user
	     will be prompted to enter the proxy password. -->
	<bean id="fodProxy" class="com.fortify.processrunner.util.rest.ContextAwareProxyConfiguration">
		<property name="name" value="FoD"/>
		<!-- <property name="uri" value="http://proxy:port/"/> -->
		<!-- <property name="userName" value="proxy user (optional)"/> -->
		<!-- <property name="password" value="proxy password (optional)"/> -->
	</bean>
	
	<!-- Define FoD connection information like base URL, client credentials, 
	     and optional proxy. Please see fodConnectionRetrieverUserCredentials 
	     below for connecting to FoD using user credentials.
	     
	     If you require a different FoD instance, you can either change the
	     base URL here, or provide the correct FoD base URL via the
	     -FoDBaseUrl command line option (which will override the base URL 
	     configured here).
	     
	     Client ID and Secret can either be configured here, or provided via 
	     the command line options -FoDClientId and -FoDClientSecret. If not 
	     provided via either configuration or command line option, the user 
	     will be prompted for the client ID and/or client secret to use. 
	-->
	<bean id="fodConnectionRetrieverClientCredentials" class="com.fortify.processrunner.fod.connection.ContextAwareFoDConnectionRetrieverClientCredentials">
		<property name="baseUrl" value="https://emea.hpfod.com/"/>
		<property name="proxy" ref="fodProxy"/>
		<!-- <property name="clientId" value="API key"/> -->
		<!-- <property name="clientSecret" value="client secret"/> -->
	</bean>
	
	<!-- Define FoD connection information like base URL, user credentials, 
	     and optional proxy. Please see fodConnectionRetrieverClientCredentials 
	     above for connecting to FoD using client credentials,
	     
	     If you require a different FoD instance, you can either change the
	     base URL here, or provide the correct FoD base URL via the
	     -FoDBaseUrl command line option (which will override the base URL 
	     configured here).
	     
	     Tenant, user name and password can either be configured here, or 
	     provided via the command line options -FoDTentant, -FoDUserName and
	     -FoDPassword respectively. Alternatively, if tenant, user name and/or 
	     password have not been provided either here or via command line options, 
	     the user will be prompted to enter the corresponding value.    
    -->
	<bean id="fodConnectionRetrieverUserCredentials" class="com.fortify.processrunner.fod.connection.ContextAwareFoDConnectionRetrieverUserCredentials">
		<property name="baseUrl" value="https://hpfod.com/"/>
		<property name="proxy" ref="fodProxy"/>
		<!-- <property name="tenant" value="tenant" /> -->
		<!-- <property name="userName" value="username"/> -->
		<!-- <property name="password" value="password"/> -->
	</bean>
	
	
	<!--==================================================================================-->
	<!-- FoD VULNERABILITY RETRIEVAL CONFIGURATION -->
	<!--==================================================================================-->
	
	<!-- This abstract bean defines common configuration options for retrieving
	     vulnerabilities from FoD, like vulnerability filter options, and extra
	     data to be retrieved. 
	     
	     Each of these properties can either be changed here (if all processor
	     configurations that you use require the same settings), or overridden 
	     in the concrete processor configurations below (if you use multiple
	     processor configurations that require different settings). 
	-->
	<bean id="fodSubmitVulnerabilitiesToBugTracker" abstract="true" class="com.fortify.processrunner.fod.processor.composite.FoDProcessorSubmitFilteredVulnerabilitiesToBugTracker">
		<!-- Define any extra data that must be loaded from FoD for filtering 
		     and/or building the issue contents. Note that previous versions
		     automatically loaded summary data, but this is no longer the case
		     if useFoDCommentForSubmittedBugs is set to false.
		     If your customized configuration depends on summary data, you 
		     will need to enable the summary field here. -->
		<property name="extraFields"><list>
			<!-- <value>summary</value> -->
			<!-- <value>details</value> -->
			<!-- <value>recommendations</value> -->
			<!-- <value>screenshots</value> -->
			<!-- <value>history</value> -->
			<!-- <value>requestResponse</value> -->
			<!-- <value>headers</value> -->
			<!-- <value>parameters</value> -->
			<!-- <value>traces</value> -->
		</list></property>
		
		<!-- Define the filters that determine which FoD vulnerabilities will
		     be submitted to the bug tracker or file.
		     
		     fod.topLevelFieldFilters allows equality-based filtering on any 
		     vulnerability attribute returned by /api/v3/Releases/${FoDReleaseId}/vulnerabilities
		     Where possible, these filters are processed by FoD, reducing the
		     number of vulnerabilities returned by FoD. As such, these filters 
		     provide best performance. Values may contain the '|' operator to
		     match against multiple allowed values.
		     
		     fod.topLevelFieldRegExFilters allows RegEx-based filtering on any
		     vulnerability attribute returned by /api/v3/Releases/${FoDReleaseId}/vulnerabilities
		     These filters are used before loading any extra fields from FoD
		     (see fod.extraFields above) and thus provide medium performance.
		     
		     fod.allFieldRegExFilters allows RegEx-based filtering on any
		     vulnerability attribute returned by either 
		     /api/v3/Releases/${FoDReleaseId}/vulnerabilities or the
		     extra fields as specified via fod.extraFields above. Since these
		     filters are only applied after loading all extra data from FoD,
		     these filters provide worst performance. 
		-->
		<property name="topLevelFieldSimpleFilters"><map>
			<entry key="isSuppressed" value="false"/>
			<entry key="severityString" value="Critical|High"/>
			<!-- <entry key="hasComments" value="false"/> -->
			<!-- <entry key="assignedUser" value="Senden, Ruud"/> -->
			<!-- <entry key="developerStatus" value="In Remediation"/> -->
			<!-- <entry key="severity" value="4"/> -->
			<!-- TODO: Add additional interesting filter fields in comments -->
		</map></property>
		<property name="topLevelFieldRegExFilters"><map>
		</map></property>
		<property name="allFieldRegExFilters"><map>
		</map></property>
		
		<!-- This flag can be set to true to add information about submitted bugs to 
		     FoD vulnerability comments. By default (false), the bug link will
		     be stored in the dedicated FoD bugLink field. Since the concrete
		     processors defined below require different settings, each concrete
		     processor explicitly sets this property. -->
		<!-- <property name="useFoDCommentForSubmittedBugs" value="false"/> -->
		
		<!-- This property defines the processor that actually submits FoD 
		     vulnerabilities to a bug tracker. The different bug tracker
		     implementations defined below explicitly set this property to
		     a corresponding vulnerability processor. -->
		<!-- <property name="vulnerabilityProcessor" ref="actualVulnerabilityProcessor"/> -->
	</bean>
	
	<!-- This abstract bean inherits all of the properties from 
	     fodSubmitVulnerabilitiesToBugTracker, but adds a group template 
	     expression to allow multiple vulnerabilities to be grouped in a 
	     single submitted bug. 
	     
	     The grouping expression can either be changed here (if all processor
	     configurations that you use require the same settings), or overridden 
	     in the concrete processor configurations below (if you use multiple
	     processor configurations that require different grouping criteria).
	-->
	<bean id="fodSubmitGroupedVulnerabilitiesToBugTracker" abstract="true" parent="fodSubmitVulnerabilitiesToBugTracker">
		<!-- Define the expression used to group vulnerabilities. This expression can use
		     any of the fields returned by the FoD vulnerabilities API. -->
		<property name="groupTemplateExpression" value="${category}+${primaryLocationFull}"/>
	</bean>
	
	
	<!--==================================================================================-->
	<!-- JIRA CONNECTION AND PROCESSOR CONFIGURATION -->
	<!--==================================================================================-->
	
	<!-- This bean defines a proxy configuration used to access JIRA. By default
	     no proxy is used. If necessary, proxy settings can either be entered here,
	     or using -JiraProxyUrl, -JiraProxyUserName and -JiraProxyPassword command line
	     options. If a proxy user name is specified without a password, the user
	     will be prompted to enter the proxy password. -->
	<bean id="jiraProxy" class="com.fortify.processrunner.util.rest.ContextAwareProxyConfiguration">
		<property name="name" value="Jira"/>
		<!-- <property name="uri" value="http://proxy:port/"/> -->
		<!-- <property name="userName" value="proxy user (optional)"/> -->
		<!-- <property name="password" value="proxy password (optional)"/> -->
	</bean>
	
	<!-- Define JIRA connection information like base URL, user name and password. 
	     
	     Base URL, user name and password can either be configured here, or
	     provided via the -JiraBaseUrl, -JiraUserName and -JiraPassword command
	     line options. Alternatively, if user name and/or password have not been 
	     provided either here or via command line options, the user will be 
	     prompted to enter the corresponding value.
	-->
	<bean id="jiraConnectionRetriever" class="com.fortify.processrunner.jira.connection.ContextAwareJiraConnectionRetriever">
		<property name="proxy" ref="jiraProxy"/>
		<!-- <property name="baseUrl" value="http://192.168.99.100:32768/"/> -->
		<!-- <property name="userName" value="rsenden"/> -->
		<!-- <property name="password" value="password"/> -->
	</bean>
	
	<!-- This bean defines the processor configuration for submitting FoD vulnerabilities 
	     to JIRA. If necessary, you can change the properties in this bean, for example 
	     to change the fields and field data submitted to JIRA. 
	-->
	<bean id="fodToJiraIssueSubmitter" class="com.fortify.processrunner.jira.processor.ProcessorSubmitIssueToJiraFromGroupedObjects">
		<property name="fields"><map>
			<!-- TODO Add examples for recommendations etcetera -->
			<entry key="summary" value="FoD Detected ${category} at ${primaryLocationFull}"/>
			<entry key="description" value="Category: ${category} at ${primaryLocationFull}"/>
			<entry key="priority.name" value="${{'Critical':'Highest','High':'High','Medium':'Medium','Low':'Low'}.get(severityString)}"/>
			<entry key="labels" value="${{'FoD'}}"/>
		</map></property>

		<!-- Define extra data to be appended to one or more of the fields defined
		     by issue.fields above. For non-grouped vulnerabilities, we could just 
		     as well have appended these expressions to the corresponding
		     issue.fields entry above. However, using issue.appendedFields allows 
		     us to re-use the same issue field configuration for grouped issues.
		     
		     Note that any field defined in issue.appendedFields, and the corresponding 
		     fields in issue.fields, must be simple string values, not an array or other 
		     complex type. -->
		<property name="appendedFields"><map>
			<entry key="description" value="\n\nId: ${id}\nLine: ${lineNumber?:'Unknown'}\nLink: ${deepLink}"/>
		</map></property>
	</bean>
	
	<!-- This bean combines fodSubmitVulnerabilitiesToBugTracker (to retrieve and process
	     non-grouped FoD vulnerabilities) with the actual Jira issue submitter. -->
	<bean id="fodToJiraProcessorNonGrouped" parent="fodSubmitVulnerabilitiesToBugTracker">
		<property name="useFoDCommentForSubmittedBugs" value="false"/>
		<property name="vulnerabilityProcessor" ref="fodToJiraIssueSubmitter"/>
	</bean>
	
	<!-- This bean combines fodSubmitGroupedVulnerabilitiesToBugTracker (to retrieve and process
	     grouped FoD vulnerabilities) with the actual Jira issue submitter. -->
	<bean id="fodToJiraProcessorGrouped" parent="fodSubmitGroupedVulnerabilitiesToBugTracker">
		<property name="useFoDCommentForSubmittedBugs" value="false"/>
		<property name="vulnerabilityProcessor" ref="fodToJiraIssueSubmitter"/>
	</bean>
	
	<!--==================================================================================-->
	<!-- JIRA PROCESS RUNNER CONFIGURATIONS -->
	<!--==================================================================================-->
	
	<!-- This process runner submits grouped vulnerabilities to JIRA, using FoD user credentials -->
	<bean id="fodUserCredentialsToJiraGrouped" class="com.fortify.processrunner.ProcessRunner">
		<property name="description" value="Submit grouped vulnerabilities to JIRA, using FoD user credentials"/>
		<property name="processor" ref="fodToJiraProcessorGrouped"/>	
		<property name="context"><map>
			<entry key="FoDConnectionRetriever" value-ref="fodConnectionRetrieverUserCredentials"/>
			<entry key="JiraConnectionRetriever" value-ref="jiraConnectionRetriever"/>
		</map></property>
	</bean>
	
	<!-- This process runner submits non-grouped vulnerabilities to JIRA, using FoD user credentials -->
	<bean id="fodUserCredentialsToJiraNonGrouped" class="com.fortify.processrunner.ProcessRunner">
		<property name="description" value="Submit non-grouped vulnerabilities to JIRA, using FoD user credentials"/>
		<property name="processor" ref="fodToJiraProcessorNonGrouped"/>	
		<property name="context"><map>
			<entry key="FoDConnectionRetriever" value-ref="fodConnectionRetrieverUserCredentials"/>
			<entry key="JiraConnectionRetriever" value-ref="jiraConnectionRetriever"/>
		</map></property>
	</bean>
		
	<!-- This process runner submits grouped vulnerabilities to JIRA, using FoD client credentials -->
	<bean id="fodClientCredentialsToJiraGrouped" class="com.fortify.processrunner.ProcessRunner">
		<property name="description" value="Submit grouped vulnerabilities to JIRA, using FoD client credentials"/>
		<property name="processor" ref="fodToJiraProcessorGrouped"/>	
		<property name="context"><map>
			<entry key="FoDConnectionRetriever" value-ref="fodConnectionRetrieverClientCredentials"/>
			<entry key="JiraConnectionRetriever" value-ref="jiraConnectionRetriever"/>
			<entry key="GroupTemplateExpression" value="${category}+${primaryLocationFull}"/>
		</map></property>
	</bean>
	
	<!-- This process runner submits non-grouped vulnerabilities to JIRA, using FoD client credentials -->
	<bean id="fodClientCredentialsToJiraNonGrouped" class="com.fortify.processrunner.ProcessRunner">
		<property name="description" value="Submit non-grouped vulnerabilities to JIRA, using FoD client credentials"/>
		<property name="processor" ref="fodToJiraProcessorNonGrouped"/>	
		<property name="context"><map>
			<entry key="FoDConnectionRetriever" value-ref="fodConnectionRetrieverClientCredentials"/>
			<entry key="JiraConnectionRetriever" value-ref="jiraConnectionRetriever"/>
		</map></property>
	</bean>
	
	<!--==================================================================================-->
	<!-- EXPORT VULNERABILITIES TO FILE PROCESSOR CONFIGURATION -->
	<!--==================================================================================-->
	
	<!-- This bean defines the processor configuration for writing FoD vulnerability
	     data to a file. If necessary, you can change the properties in this bean, for 
	     example to change the fields and field data submitted to the file.
	-->
	<bean id="fodToFileIssueSubmitter" class="com.fortify.processrunner.file.ProcessorSubmitIssueToFileFromGroupedObjects">
		<property name="fields"><map>
			<entry key="id" value="${id}"/>
			<entry key="vulnId" value="${vulnId}"/>
			<entry key="category" value="${category}"/>
			<entry key="primaryLocationFull" value="${primaryLocationFull}"/>
			<entry key="severity" value="${severityString}"/>
			<entry key="deepLink" value="${deepLink}"/>
		</map></property>
	</bean>
	
	<!-- This bean combines fodSubmitVulnerabilitiesToBugTracker (to retrieve and process
	     non-grouped FoD vulnerabilities) with the actual file issue submitter. -->
	<bean id="fodToFileProcessorNonGrouped" parent="fodSubmitVulnerabilitiesToBugTracker">
		<property name="useFoDCommentForSubmittedBugs" value="true"/>
		<property name="vulnerabilityProcessor" ref="fodToFileIssueSubmitter"/>
	</bean>
	
	<!--==================================================================================-->
	<!-- EXPORT VULNERABILITIES TO FILE PROCESS RUNNER CONFIGURATIONS -->
	<!--==================================================================================-->
	
	<!-- This process runner submits non-grouped vulnerabilities to a file, using FoD user credentials -->
	<bean id="fodUserCredentialsToFileNonGrouped" class="com.fortify.processrunner.ProcessRunner">
		<property name="description" value="Submit non-grouped vulnerabilities to a file using FoD user credentials"/>
		<property name="processor" ref="fodToFileProcessorNonGrouped"/>	
		<property name="context"><map>
			<entry key="FoDConnectionRetriever" value-ref="fodConnectionRetrieverUserCredentials"/>
		</map></property>
	</bean>
	
	<!-- This process runner submits non-grouped vulnerabilities to a file, using FoD client credentials -->
	<bean id="fodClientCredentialsToFileNonGrouped" class="com.fortify.processrunner.ProcessRunner">
		<property name="description" value="Submit non-grouped vulnerabilities to a file, using FoD client credentials"/>
		<property name="processor" ref="fodToFileProcessorNonGrouped"/>	
		<property name="context"><map>
			<entry key="FoDConnectionRetriever" value-ref="fodConnectionRetrieverClientCredentials"/>
		</map></property>
	</bean>
	
</beans>
