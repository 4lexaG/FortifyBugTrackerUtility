<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:aop="http://www.springframework.org/schema/aop"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:lang="http://www.springframework.org/schema/lang" xmlns:util="http://www.springframework.org/schema/util"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.2.xsd
		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.2.xsd
		http://www.springframework.org/schema/lang http://www.springframework.org/schema/lang/spring-lang-4.2.xsd
		http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-4.2.xsd">
		
	<import resource="components/input/SSCInputConfig.xml"/>
	
	<!--==================================================================================-->
	<!-- SSC TO JIRA PROCESSOR CONFIGURATION -->
	<!--==================================================================================-->
	
	<!-- This bean defines the context for the SSC to JIRA processing. All of these
	     properties can also be specified on the command line. -->
	<util:map id="contextProperties">
		<!-- TODO Add all possible properties -->
		<entry key="" value=""/>
	</util:map>
	
	<!-- This bean defines the processor configuration for submitting
	     vulnerabilities to JIRA. If necessary, you can change the properties 
	     in this bean, for example to change the grouping expression, fields 
	     and field data submitted to JIRA. 
	-->
	<bean id="sscToJiraIssueSubmitter" class="com.fortify.processrunner.jira.processor.ProcessorJiraSubmitIssueForVulnerabilities">
		<!-- Expression for grouping vulnerabilities into a single JIRA issue. Note that
		     grouping must be explicitly enabled using the EnableGrouping context property -->
		<property name="groupTemplateExpression" value="${category}+${primaryLocationFull}"/>
	
		<property name="fields"><map>
			<!-- TODO Add examples for recommendations etcetera -->
			<entry key="summary" value="SSC Detected ${issueName} at ${fullFileName}"/>
			<entry key="description" value="--- Changes to the description will be overwritten when FoDBugTrackerUtility updates issues states ---\n\nCategory: ${issueName} at ${fullFileName}"/>
			<entry key="priority.name" value="${{'Critical':'Highest','High':'High','Medium':'Medium','Low':'Low'}.get(friority)}"/>
			<entry key="labels" value="${{'SSC'}}"/>
		</map></property>

		<!-- Define extra data to be appended to one or more of the fields defined
		     by issue.fields above. For non-grouped vulnerabilities, we could just 
		     as well have appended these expressions to the corresponding
		     issue.fields entry above. However, using issue.appendedFields allows 
		     us to re-use the same issue field configuration for grouped issues.
		-->
		<property name="appendedFields"><map>
			<entry key="description" value="\n\nId: ${id}\nState: ${vulnState}\nLine: ${lineNumber?:'Unknown'}\nLink: ${deepLink}"/>
		</map></property>
	</bean>
	
	<!-- This bean defines the processor configuration for updating JIRA issue state
	     based on SSC vulnerability state. This processor can update issue fields,
	     automatically re-open issues, and automatically close issues. Each of these
	     actions is optional; if a property is not defined, the corresponding action
	     will not be performed.
	-->
	<bean id="sscToJiraIssueUpdater" class="com.fortify.processrunner.jira.processor.ProcessorJiraTransitionIssueStateForVulnerabilities">
		<!-- Update the JIRA description field when updating issue state -->
		<property name="fieldsToUpdate" value="description"/>
		
		<!-- Define when a JIRA issue is considered re-openable or closeable. These expressions
		     can utilize all properties in the status and resolution fields returned by the JIRA
		     REST API, usually you will want to match on status.name and/or resolution.name. If
		     not defined, an issue is considered openable/closeable if a valid transition exists. -->
		<!--
		<property name="isIssueOpenableExpression"><value><![CDATA[
			resolution.name matches 'something|something else'
		]]></value></property>
		<property name="isIssueCloseableExpression"><value><![CDATA[
			
		]]></value></property>
		-->
		
		<!-- Define the transitions for re-opening and closing issues. The map key defines an expression
		     that defines when to use a specific transition; this is usually based on issue status.name.
		     The map value defines one or more names of transitions that need to be performed in order to 
		     re-open or close an issue. For each transition, you can specify an optional comment between
		     brackets. If your JIRA instance uses non-standard workflows, you may need to update these
		     mappings.-->
		<property name="transitionsForOpeningIssue"><map>
			<!-- JIRA default workflow -->
			<entry key="status.name matches 'Closed|Resolved'" value="Reopen Issue[Issue re-opened by FoDBugTrackerUtility]"/>
			<!-- JIRA Software Simplified Workflow -->
			<entry key="status.name matches 'Done'" value="To Do[Issue re-opened by FoDBugTrackerUtility]"/>
		</map></property>
		<property name="transitionsForClosingIssue"><map>
			<!-- JIRA default workflow -->
			<entry key="status.name matches 'Open|In Progress|Reopened'" value="Close Issue[Issue closed by FoDBugTrackerUtility]"/>
			<!-- JIRA Software Simplified Workflow -->
			<entry key="status.name matches 'To Do|In Progress|In Review'" value="Done[Issue closed by FoDBugTrackerUtility]"/>
			<!-- Example on performing multiple transitions to reach the target state -->
			<entry key="status.name matches 'My Custom Status'"><list>
				<value>IntermediateTransition1</value> <!-- Transition without comment -->
				<value>IntermediateTransition2[Intermediate transition performed by FoDBugTrackerUtility]</value>
				<value>FinalTransition[Issue closed by FoDBugTrackerUtility]</value>
			</list></entry>
		</map></property>
	</bean>
	
</beans>
